import idc
import idaapi
import sys


idc.Wait()
if len(idc.ARGV) == 2:
    tmp_dir = idc.ARGV[1]
    for tmp_file in sorted(os.listdir(tmp_dir)):
        if tmp_file.endswith('.dmp'):
            with open("{}/{}".format(tmp_dir,tmp_file)) as f:
                data = f.read()
                start_addr = int(tmp_file.split('.')[0],16)
                stop_addr = (start_addr + len(data)) | 0xfff
                idc.SegCreate(start_addr, stop_addr, 0, 1, 0, idaapi.scPub)
                idc.SetSegmentType(start_addr,idc.SEG_CODE)
                idaapi.put_many_bytes(start_addr,data)
    # reanalyze after adding all the new sections
    idc.AnalyzeArea(0,idc.BADADDR)
# compresses the DB
idc.SaveBase('{}.idb'.format(idc.GetInputFile()),flags=idaapi.DBFL_COMP)
idc.Exit(0)
